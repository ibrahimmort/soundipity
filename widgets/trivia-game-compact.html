<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia Showdown - Compact</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee&family=Fredoka:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #0a0a1f 0%, #1a0a2e 50%, #16003b 100%);
            height: 100vh;
            color: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 6px;
        }

        .header {
            text-align: center;
            margin-bottom: 6px;
        }

        .header h1 {
            font-family: 'Bungee', cursive;
            font-size: 1.2em;
            background: linear-gradient(45deg, #ff2e97, #ffed00, #00d9ff, #39ff14);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header p {
            font-size: 0.65em;
            color: #00d9ff;
            font-weight: 600;
        }

        .screen {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        /* Home Screen */
        .home-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .topic-section {
            background: rgba(26, 26, 62, 0.8);
            border: 2px solid #bc13fe;
            border-radius: 8px;
            padding: 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .topic-section h2 {
            font-family: 'Bungee', cursive;
            font-size: 0.9em;
            color: #ffed00;
            margin-bottom: 6px;
        }

        .topic-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            flex: 1;
            overflow-y: auto;
        }

        .topic-item {
            background: rgba(57, 255, 20, 0.1);
            border: 1px solid #39ff14;
            padding: 6px;
            border-radius: 6px;
            font-size: 0.65em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .topic-number {
            background: #39ff14;
            color: #0a0a1f;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .topic-text {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .topic-votes {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.85em;
            flex-shrink: 0;
        }

        .big-button {
            background: linear-gradient(135deg, #ff2e97, #bc13fe);
            border: none;
            padding: 8px 16px;
            font-size: 0.8em;
            font-family: 'Bungee', cursive;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 6px;
        }

        .big-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Question Screen */
        .question-container {
            background: rgba(26, 26, 62, 0.8);
            border: 2px solid #00d9ff;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.7em;
        }

        .question-number {
            font-family: 'Bungee', cursive;
            color: #ffed00;
        }

        .topic-badge {
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid #00d9ff;
            padding: 3px 8px;
            border-radius: 6px;
            color: #00d9ff;
            font-weight: 600;
            font-size: 0.9em;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .question-text {
            font-size: 0.8em;
            font-weight: 700;
            margin-bottom: 6px;
            line-height: 1.3;
            flex-shrink: 0;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            flex: 1;
            overflow: hidden;
        }

        .answer-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 6px;
            border-radius: 6px;
            font-size: 0.65em;
            position: relative;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .answer-letter {
            display: inline-flex;
            background: #bc13fe;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Bungee', cursive;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .answer-text {
            flex: 1;
            line-height: 1.2;
        }

        .answer-votes {
            position: absolute;
            top: 3px;
            right: 3px;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 5px;
            border-radius: 8px;
            font-size: 0.8em;
        }

        .answer-option.correct {
            border-color: #39ff14;
            background: rgba(57, 255, 20, 0.2);
        }

        .answer-option.incorrect {
            border-color: #ff2e97;
            opacity: 0.5;
        }

        .control-buttons {
            display: flex;
            gap: 4px;
            margin-top: 6px;
            flex-shrink: 0;
        }

        .control-btn {
            flex: 1;
            padding: 6px 12px;
            font-size: 0.65em;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .reveal-btn {
            background: linear-gradient(135deg, #ffed00, #39ff14);
            color: #0a0a1f;
        }

        .next-btn {
            background: linear-gradient(135deg, #00d9ff, #bc13fe);
            color: white;
        }

        /* Leaderboard Screen */
        .leaderboard-container {
            background: rgba(26, 26, 62, 0.8);
            border: 2px solid #ffed00;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .leaderboard-title {
            font-family: 'Bungee', cursive;
            font-size: 1em;
            text-align: center;
            color: #ffed00;
            margin-bottom: 6px;
        }

        .winner-spotlight {
            text-align: center;
            padding: 8px;
            background: linear-gradient(135deg, rgba(255, 46, 151, 0.2), rgba(188, 19, 254, 0.2));
            border-radius: 8px;
            border: 2px solid #ff2e97;
            margin-bottom: 6px;
        }

        .winner-crown {
            font-size: 2em;
        }

        .winner-name {
            font-size: 0.9em;
            font-weight: 700;
            color: #ffed00;
            margin: 3px 0;
        }

        .winner-score {
            font-size: 0.7em;
            color: #39ff14;
        }

        .top-players {
            flex: 1;
            overflow-y: auto;
        }

        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 6px;
            margin: 2px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 0.7em;
        }

        .player-rank {
            font-weight: bold;
            color: #bc13fe;
            min-width: 25px;
        }

        .player-name {
            flex: 1;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-score {
            color: #39ff14;
            font-weight: bold;
        }

        /* Loading Screen */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #ff2e97;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 0.8em;
            color: #00d9ff;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéÆ TRIVIA üéÆ</h1>
        <p>Community Quiz!</p>
    </div>

    <!-- HOME SCREEN -->
    <div id="homeScreen" class="screen active">
        <div class="home-content">
            <div class="topic-section">
                <h2>Pick Topic!</h2>
                <div class="topic-list" id="topicList"></div>
                <button class="big-button" id="startQuizBtn" onclick="startQuiz()">
                    START! üöÄ
                </button>
            </div>
        </div>
    </div>

    <!-- QUESTION SCREEN -->
    <div id="questionScreen" class="screen">
        <div class="question-container">
            <div class="question-header">
                <div class="question-number" id="questionNumber">Q 1/10</div>
                <div class="topic-badge" id="topicBadge">Topic</div>
            </div>

            <div class="question-text" id="questionText">Loading...</div>

            <div class="answers-grid" id="answersGrid"></div>

            <div class="control-buttons">
                <button class="control-btn reveal-btn" id="revealBtn" onclick="revealAnswer()">
                    Reveal ‚ú®
                </button>
                <button class="control-btn next-btn" id="nextBtn" onclick="nextQuestion()" disabled>
                    Next ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- LEADERBOARD SCREEN -->
    <div id="leaderboardScreen" class="screen">
        <div class="leaderboard-container">
            <div class="leaderboard-title">üèÜ RESULTS üèÜ</div>

            <div class="winner-spotlight">
                <div class="winner-crown">üëë</div>
                <div class="winner-name" id="winnerName">Champion</div>
                <div class="winner-score" id="winnerScore">10/10</div>
            </div>

            <div class="top-players" id="topPlayers"></div>

            <button class="big-button" onclick="resetGame()">
                Play Again! üéÆ
            </button>
        </div>
    </div>

    <!-- LOADING SCREEN -->
    <div id="loadingScreen" class="screen">
        <div class="loading">
            <div class="spinner"></div>
            <div class="loading-text">Generating...</div>
        </div>
    </div>

    <script>
        let gameState = {
            currentScreen: 'home',
            topics: new Map(),
            currentTopic: '',
            questions: [],
            currentQuestionIndex: 0,
            playerScores: new Map(),
            answerRevealed: false,
            currentAnswers: new Map()
        };

        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenName + 'Screen').classList.add('active');
            gameState.currentScreen = screenName;
        }

        async function generateTopics() {
            showScreen('loading');
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Generate 8 fun trivia topics. Return ONLY a JSON array: ["Topic 1", "Topic 2", ...]`
                        }]
                    })
                });

                const data = await response.json();
                const textContent = data.content.find(c => c.type === 'text')?.text || '';
                const jsonMatch = textContent.match(/\[[\s\S]*\]/);
                
                if (jsonMatch) {
                    const topics = JSON.parse(jsonMatch[0]);
                    gameState.topics.clear();
                    topics.forEach(topic => {
                        gameState.topics.set(topic, { votes: 0, voters: new Set() });
                    });
                    updateTopicList();
                    showScreen('home');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error:', error);
                showScreen('home');
                return false;
            }
        }

        function processVote(username, voteNumber) {
            const topics = Array.from(gameState.topics.keys());
            const topicIndex = voteNumber - 1;
            
            if (topicIndex >= 0 && topicIndex < topics.length) {
                const topic = topics[topicIndex];
                const topicData = gameState.topics.get(topic);
                
                gameState.topics.forEach((data, t) => {
                    if (data.voters.has(username)) {
                        data.voters.delete(username);
                        data.votes--;
                    }
                });
                
                topicData.voters.add(username);
                topicData.votes++;
                updateTopicList();
            }
        }

        function updateTopicList() {
            const listEl = document.getElementById('topicList');
            const sortedTopics = Array.from(gameState.topics.entries())
                .sort((a, b) => b[1].votes - a[1].votes);
            
            listEl.innerHTML = sortedTopics.map(([topic, data], index) => `
                <div class="topic-item">
                    <span class="topic-number">${index + 1}</span>
                    <span class="topic-text" title="${topic}">${topic}</span>
                    <span class="topic-votes">${data.votes}</span>
                </div>
            `).join('');
        }

        async function startQuiz() {
            const btn = document.getElementById('startQuizBtn');
            btn.disabled = true;
            
            // If no topics exist yet, generate them first
            if (gameState.topics.size === 0) {
                const success = await generateTopics();
                if (!success) {
                    btn.disabled = false;
                    alert('Failed to generate topics. Please try again!');
                    return;
                }
                // Wait a moment for topics to settle
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const sortedTopics = Array.from(gameState.topics.entries())
                .sort((a, b) => b[1].votes - a[1].votes);
            
            if (sortedTopics.length === 0) {
                btn.disabled = false;
                alert('No topics available!');
                return;
            }
            
            gameState.currentTopic = sortedTopics[0][0];
            showScreen('loading');

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Generate 10 trivia questions about "${gameState.currentTopic}". Return ONLY JSON: [{"question":"...", "answers":["A)...", "B)...", "C)...", "D)..."], "correct":0}]`
                        }]
                    })
                });

                const data = await response.json();
                const textContent = data.content.find(c => c.type === 'text')?.text || '';
                const jsonMatch = textContent.match(/\[[\s\S]*\]/);
                
                if (jsonMatch) {
                    gameState.questions = JSON.parse(jsonMatch[0]);
                    gameState.currentQuestionIndex = 0;
                    gameState.playerScores.clear();
                    startQuestion();
                } else {
                    throw new Error('Could not parse questions');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate questions. Please try again!');
                showScreen('home');
            } finally {
                btn.disabled = false;
            }
        }

        function startQuestion() {
            showScreen('question');
            gameState.answerRevealed = false;
            gameState.currentAnswers.clear();
            
            const question = gameState.questions[gameState.currentQuestionIndex];
            
            document.getElementById('questionNumber').textContent = 
                `Q ${gameState.currentQuestionIndex + 1}/10`;
            document.getElementById('topicBadge').textContent = gameState.currentTopic;
            document.getElementById('questionText').textContent = question.question;
            
            const answersGrid = document.getElementById('answersGrid');
            answersGrid.innerHTML = question.answers.map((answer, index) => `
                <div class="answer-option" data-index="${index}">
                    <span class="answer-letter">${['A', 'B', 'C', 'D'][index]}</span>
                    <span class="answer-text">${answer.replace(/^[A-D]\)\s*/, '')}</span>
                    <span class="answer-votes">0</span>
                </div>
            `).join('');
            
            document.getElementById('revealBtn').disabled = false;
            document.getElementById('nextBtn').disabled = true;
        }

        function processAnswer(username, answerLetter) {
            if (gameState.answerRevealed) return;
            const answerIndex = ['a', 'b', 'c', 'd'].indexOf(answerLetter.toLowerCase());
            if (answerIndex === -1) return;
            gameState.currentAnswers.set(username, answerIndex);
            updateAnswerVotes();
        }

        function updateAnswerVotes() {
            const voteCounts = [0, 0, 0, 0];
            gameState.currentAnswers.forEach(answer => voteCounts[answer]++);
            document.querySelectorAll('.answer-option').forEach((el, index) => {
                el.querySelector('.answer-votes').textContent = voteCounts[index];
            });
        }

        function revealAnswer() {
            gameState.answerRevealed = true;
            const question = gameState.questions[gameState.currentQuestionIndex];
            const correctIndex = question.correct;
            
            document.querySelectorAll('.answer-option').forEach((el, index) => {
                if (index === correctIndex) {
                    el.classList.add('correct');
                } else {
                    el.classList.add('incorrect');
                }
            });
            
            gameState.currentAnswers.forEach((answer, username) => {
                if (answer === correctIndex) {
                    const currentScore = gameState.playerScores.get(username) || 0;
                    gameState.playerScores.set(username, currentScore + 1);
                }
            });
            
            document.getElementById('revealBtn').disabled = true;
            document.getElementById('nextBtn').disabled = false;
        }

        function nextQuestion() {
            gameState.currentQuestionIndex++;
            if (gameState.currentQuestionIndex >= gameState.questions.length) {
                showLeaderboard();
            } else {
                startQuestion();
            }
        }

        function showLeaderboard() {
            showScreen('leaderboard');
            
            const sortedPlayers = Array.from(gameState.playerScores.entries())
                .sort((a, b) => b[1] - a[1]);
            
            if (sortedPlayers.length > 0) {
                const [winner, score] = sortedPlayers[0];
                document.getElementById('winnerName').textContent = winner;
                document.getElementById('winnerScore').textContent = `${score}/10`;
                
                const topPlayersHTML = sortedPlayers.slice(0, 10).map(([name, score], index) => `
                    <div class="player-row">
                        <span class="player-rank">#${index + 1}</span>
                        <span class="player-name">${name}</span>
                        <span class="player-score">${score}</span>
                    </div>
                `).join('');
                
                document.getElementById('topPlayers').innerHTML = topPlayersHTML;
            }
        }

        function resetGame() {
            gameState.topics.clear();
            gameState.questions = [];
            gameState.currentQuestionIndex = 0;
            gameState.playerScores.clear();
            gameState.currentAnswers.clear();
            generateTopics();
        }

        function processChatCommand(username, message) {
            const lowerMessage = message.toLowerCase().trim();
            
            if (lowerMessage.startsWith('!vote ')) {
                const voteNum = parseInt(lowerMessage.substring(6));
                processVote(username, voteNum);
            } else if (lowerMessage.match(/^![abcd]$/)) {
                processAnswer(username, lowerMessage.substring(1));
            }
        }

        window.processChatCommand = processChatCommand;
        
        // Listen for commands from control dashboard
        window.addEventListener('storage', function(e) {
            if (e.key === 'streamCommand') {
                try {
                    const command = JSON.parse(e.newValue);
                    if (command.widget === 'trivia') {
                        handleDashboardCommand(command.command, command.data);
                    }
                } catch (err) {
                    console.error('Error processing command:', err);
                }
            }
        });
        
        function handleDashboardCommand(command, data) {
            switch(command) {
                case 'generateTopics':
                    generateTopics();
                    break;
                case 'vote':
                    processVote('ControlDashboard' + Math.floor(Math.random() * 1000), data);
                    break;
                case 'simulateVotes':
                    for (let i = 0; i < (data.count || 15); i++) {
                        setTimeout(() => {
                            const topics = Array.from(gameState.topics.keys());
                            if (topics.length > 0) {
                                const randomVote = Math.floor(Math.random() * topics.length) + 1;
                                processVote('User' + Math.floor(Math.random() * 100), randomVote);
                            }
                        }, i * 100);
                    }
                    break;
                case 'answer':
                    processAnswer('ControlDashboard' + Math.floor(Math.random() * 1000), data);
                    break;
                case 'simulateAnswers':
                    for (let i = 0; i < (data.count || 15); i++) {
                        setTimeout(() => {
                            const answers = ['a', 'b', 'c', 'd'];
                            const randomAnswer = answers[Math.floor(Math.random() * 4)];
                            processAnswer('User' + Math.floor(Math.random() * 100), randomAnswer);
                        }, i * 150);
                    }
                    break;
            }
        }
        
        // Generate topics on load
        generateTopics();
    </script>
</body>
</html>
