<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Trivia Showdown!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee&family=Fredoka:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-pink: #ff2e97;
            --neon-blue: #00d9ff;
            --neon-yellow: #ffed00;
            --neon-green: #39ff14;
            --neon-purple: #bc13fe;
            --dark-bg: #0a0a1f;
            --card-bg: #1a1a3e;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #0a0a1f 0%, #1a0a2e 50%, #16003b 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated background elements */
        .bg-decoration {
            position: fixed;
            pointer-events: none;
            z-index: 0;
        }

        .circle-1 {
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--neon-pink) 0%, transparent 70%);
            top: -200px;
            right: -200px;
            opacity: 0.15;
            animation: float 8s ease-in-out infinite;
        }

        .circle-2 {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--neon-blue) 0%, transparent 70%);
            bottom: -150px;
            left: -150px;
            opacity: 0.15;
            animation: float 6s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(30px, -30px) rotate(180deg); }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header h1 {
            font-family: 'Bungee', cursive;
            font-size: 4em;
            background: linear-gradient(45deg, var(--neon-pink), var(--neon-yellow), var(--neon-blue), var(--neon-green));
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
            text-shadow: 0 0 30px rgba(255, 46, 151, 0.5);
            margin-bottom: 10px;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header p {
            font-size: 1.3em;
            color: var(--neon-blue);
            font-weight: 600;
        }

        /* Screens */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Home Screen */
        .home-content {
            text-align: center;
        }

        .topic-input-section {
            background: var(--card-bg);
            border: 3px solid var(--neon-purple);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 0 40px rgba(188, 19, 254, 0.3);
        }

        .topic-input-section h2 {
            font-family: 'Bungee', cursive;
            font-size: 2em;
            color: var(--neon-yellow);
            margin-bottom: 20px;
        }

        .topic-input-section p {
            font-size: 1.1em;
            margin-bottom: 20px;
            color: #ccc;
        }

        .command-hint {
            display: inline-block;
            background: rgba(255, 237, 0, 0.2);
            border: 2px solid var(--neon-yellow);
            padding: 10px 20px;
            border-radius: 10px;
            font-family: monospace;
            color: var(--neon-yellow);
            margin: 10px 0;
        }

        .suggested-topics {
            margin-top: 30px;
        }

        .suggested-topics h3 {
            color: var(--neon-green);
            margin-bottom: 15px;
        }

        .topic-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .topic-item {
            background: rgba(57, 255, 20, 0.1);
            border: 2px solid var(--neon-green);
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .topic-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(57, 255, 20, 0.3);
        }

        .topic-number {
            background: var(--neon-green);
            color: var(--dark-bg);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .topic-votes {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .big-button {
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
            border: none;
            padding: 20px 50px;
            font-size: 1.5em;
            font-family: 'Bungee', cursive;
            color: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 46, 151, 0.4);
            margin-top: 20px;
        }

        .big-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(255, 46, 151, 0.6);
        }

        .big-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Question Screen */
        .question-container {
            background: var(--card-bg);
            border: 3px solid var(--neon-blue);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 0 40px rgba(0, 217, 255, 0.3);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .question-number {
            font-family: 'Bungee', cursive;
            font-size: 1.5em;
            color: var(--neon-yellow);
        }

        .topic-badge {
            background: rgba(0, 217, 255, 0.2);
            border: 2px solid var(--neon-blue);
            padding: 10px 20px;
            border-radius: 10px;
            color: var(--neon-blue);
            font-weight: 600;
        }

        .question-text {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 30px;
            line-height: 1.4;
            color: white;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .answer-option {
            background: rgba(255, 255, 255, 0.05);
            border: 3px solid rgba(255, 255, 255, 0.3);
            padding: 25px;
            border-radius: 15px;
            font-size: 1.3em;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .answer-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transition: width 0.3s ease;
        }

        .answer-option:hover {
            border-color: var(--neon-yellow);
            transform: translateY(-5px);
        }

        .answer-letter {
            display: inline-block;
            background: var(--neon-purple);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            margin-right: 15px;
            font-weight: bold;
            font-family: 'Bungee', cursive;
        }

        .answer-votes {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
        }

        .answer-option.correct {
            border-color: var(--neon-green);
            background: rgba(57, 255, 20, 0.2);
            animation: correctPulse 0.6s ease;
        }

        .answer-option.incorrect {
            border-color: var(--neon-pink);
            background: rgba(255, 46, 151, 0.1);
            opacity: 0.5;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 15px 35px;
            font-size: 1.2em;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reveal-btn {
            background: linear-gradient(135deg, var(--neon-yellow), var(--neon-green));
            color: var(--dark-bg);
        }

        .next-btn {
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
            color: white;
        }

        .control-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Leaderboard Screen */
        .leaderboard-container {
            background: var(--card-bg);
            border: 3px solid var(--neon-yellow);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 0 40px rgba(255, 237, 0, 0.3);
        }

        .leaderboard-title {
            font-family: 'Bungee', cursive;
            font-size: 3em;
            text-align: center;
            color: var(--neon-yellow);
            margin-bottom: 30px;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .winner-spotlight {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(255, 46, 151, 0.2), rgba(188, 19, 254, 0.2));
            border-radius: 20px;
            border: 3px solid var(--neon-pink);
        }

        .winner-crown {
            font-size: 5em;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .winner-name {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--neon-yellow);
            margin: 10px 0;
        }

        .winner-score {
            font-size: 1.5em;
            color: var(--neon-green);
        }

        .top-players {
            margin-top: 30px;
        }

        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .player-row:hover {
            border-color: var(--neon-blue);
            transform: translateX(10px);
        }

        .player-rank {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--neon-purple);
            min-width: 50px;
        }

        .player-name {
            flex: 1;
            font-size: 1.3em;
            font-weight: 600;
        }

        .player-score {
            font-size: 1.5em;
            color: var(--neon-green);
            font-weight: bold;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--neon-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            font-size: 1.5em;
            color: var(--neon-blue);
        }

        /* Test Controls */
        .test-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid var(--neon-pink);
            z-index: 1000;
            max-width: 300px;
        }

        .test-controls h3 {
            color: var(--neon-pink);
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .test-controls button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: linear-gradient(135deg, var(--neon-purple), var(--neon-blue));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .test-controls button:hover {
            transform: scale(1.05);
        }

        .test-controls input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
            font-family: 'Fredoka', sans-serif;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5em;
            }

            .question-text {
                font-size: 1.5em;
            }

            .answers-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-decoration circle-1"></div>
    <div class="bg-decoration circle-2"></div>

    <div class="container">
        <div class="header">
            <h1>üéÆ TRIVIA SHOWDOWN üéÆ</h1>
            <p>Community-Powered Quiz Game!</p>
        </div>

        <!-- HOME SCREEN -->
        <div id="homeScreen" class="screen active">
            <div class="home-content">
                <div class="topic-input-section">
                    <h2>üéØ Pick Your Topic!</h2>
                    <p>AI has generated some amazing trivia topics - chat votes for their favorite!</p>
                    <div class="command-hint">!vote [number]</div>

                    <div class="suggested-topics">
                        <h3>üìã AI-Generated Topics:</h3>
                        <div class="topic-list" id="topicList">
                            <!-- Topics will be generated by AI -->
                        </div>
                        <button class="big-button" id="startQuizBtn" onclick="startQuiz()">
                            START TRIVIA! üöÄ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- QUESTION SCREEN -->
        <div id="questionScreen" class="screen">
            <div class="question-container">
                <div class="question-header">
                    <div class="question-number" id="questionNumber">Question 1/10</div>
                    <div class="topic-badge" id="topicBadge">Topic</div>
                </div>

                <div class="question-text" id="questionText">
                    Loading question...
                </div>

                <div class="answers-grid" id="answersGrid">
                    <!-- Answers will be populated here -->
                </div>

                <div class="control-buttons">
                    <button class="control-btn reveal-btn" id="revealBtn" onclick="revealAnswer()">
                        Reveal Answer ‚ú®
                    </button>
                    <button class="control-btn next-btn" id="nextBtn" onclick="nextQuestion()" disabled>
                        Next Question ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD SCREEN -->
        <div id="leaderboardScreen" class="screen">
            <div class="leaderboard-container">
                <div class="leaderboard-title">üèÜ FINAL RESULTS üèÜ</div>

                <div class="winner-spotlight">
                    <div class="winner-crown">üëë</div>
                    <div class="winner-name" id="winnerName">Champion</div>
                    <div class="winner-score" id="winnerScore">10/10 Points</div>
                </div>

                <div class="top-players" id="topPlayers">
                    <!-- Top players will be populated here -->
                </div>

                <button class="big-button" onclick="resetGame()">
                    Play Again! üéÆ
                </button>
            </div>
        </div>

        <!-- LOADING SCREEN -->
        <div id="loadingScreen" class="screen">
            <div class="loading">
                <div class="spinner"></div>
                <div class="loading-text">Generating epic questions... ‚ö°</div>
            </div>
        </div>
    </div>

    <!-- Test Controls -->
    <div class="test-controls">
        <h3>üß™ Test Controls</h3>
        <input type="text" id="testUsername" placeholder="Username" value="TestUser">
        <button onclick="testVote()">Vote Random Topic</button>
        <button onclick="testAnswer()">Answer Random</button>
        <button onclick="simulateChat()">Simulate Active Chat</button>
        <button onclick="generateTopics()">Regenerate Topics</button>
    </div>

    <script>
        // Game State
        let gameState = {
            currentScreen: 'home',
            topics: new Map(),
            currentTopic: '',
            questions: [],
            currentQuestionIndex: 0,
            playerScores: new Map(),
            answerRevealed: false,
            currentAnswers: new Map()
        };

        // Sound effects (using Web Audio API)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'correct':
                    oscillator.frequency.value = 523.25; // C5
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;
                case 'wrong':
                    oscillator.frequency.value = 196.00; // G3
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                case 'success':
                    // Play a chord
                    [523.25, 659.25, 783.99].forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                        osc.start(audioContext.currentTime + i * 0.1);
                        osc.stop(audioContext.currentTime + 0.8);
                    });
                    break;
            }
        }

        // Screen Management
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenName + 'Screen').classList.add('active');
            gameState.currentScreen = screenName;
        }

        // Generate Topics with AI
        async function generateTopics() {
            showScreen('loading');
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Generate 8 fun, diverse trivia topic ideas that would be exciting for a live stream audience. Make them varied - mix pop culture, history, science, entertainment, random fun facts, etc.

Return ONLY a JSON array of topic strings, no other text:
["Topic 1", "Topic 2", "Topic 3", ...]

Make them catchy and interesting!`
                        }]
                    })
                });

                const data = await response.json();
                const textContent = data.content.find(c => c.type === 'text')?.text || '';
                
                // Extract JSON from response
                const jsonMatch = textContent.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    const topics = JSON.parse(jsonMatch[0]);
                    
                    // Initialize topics with 0 votes
                    gameState.topics.clear();
                    topics.forEach(topic => {
                        gameState.topics.set(topic, { votes: 0, voters: new Set() });
                    });
                    
                    updateTopicList();
                    showScreen('home');
                } else {
                    throw new Error('Could not parse topics');
                }
            } catch (error) {
                console.error('Error generating topics:', error);
                alert('Failed to generate topics. Please refresh and try again!');
            }
        }

        // Topic Voting (no more manual suggestion)
        function processVote(username, voteNumber) {
            const topics = Array.from(gameState.topics.keys());
            const topicIndex = voteNumber - 1;
            
            if (topicIndex >= 0 && topicIndex < topics.length) {
                const topic = topics[topicIndex];
                const topicData = gameState.topics.get(topic);
                
                // Remove previous vote from this user
                gameState.topics.forEach((data, t) => {
                    if (data.voters.has(username)) {
                        data.voters.delete(username);
                        data.votes--;
                    }
                });
                
                // Add new vote
                topicData.voters.add(username);
                topicData.votes++;
                
                updateTopicList();
            }
        }

        function updateTopicList() {
            const listEl = document.getElementById('topicList');
            const sortedTopics = Array.from(gameState.topics.entries())
                .sort((a, b) => b[1].votes - a[1].votes);
            
            listEl.innerHTML = sortedTopics.map(([topic, data], index) => `
                <div class="topic-item">
                    <span class="topic-number">${index + 1}</span>
                    <span>${topic}</span>
                    <span class="topic-votes">${data.votes} votes</span>
                </div>
            `).join('');
        }

        // Start Quiz
        async function startQuiz() {
            if (gameState.topics.size === 0) {
                alert('Need at least one topic suggestion!');
                return;
            }

            // Get winning topic - the one with most votes
            const sortedTopics = Array.from(gameState.topics.entries())
                .sort((a, b) => b[1].votes - a[1].votes);
            
            gameState.currentTopic = sortedTopics[0][0];
            
            console.log('Selected topic:', gameState.currentTopic, 'with', sortedTopics[0][1].votes, 'votes');

            showScreen('loading');

            // Generate questions using Claude API
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Generate 10 multiple choice trivia questions about "${gameState.currentTopic}". Mix of easy, medium, and hard difficulty.

Return ONLY a JSON array with this exact structure, no other text:
[
  {
    "question": "Question text here?",
    "answers": ["A) Answer 1", "B) Answer 2", "C) Answer 3", "D) Answer 4"],
    "correct": 0
  }
]

The "correct" field should be the index (0-3) of the correct answer. Make questions fun and engaging!`
                        }]
                    })
                });

                const data = await response.json();
                const textContent = data.content.find(c => c.type === 'text')?.text || '';
                
                // Extract JSON from response
                const jsonMatch = textContent.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    gameState.questions = JSON.parse(jsonMatch[0]);
                    gameState.currentQuestionIndex = 0;
                    gameState.playerScores.clear();
                    startQuestion();
                } else {
                    throw new Error('Could not parse questions');
                }
            } catch (error) {
                console.error('Error generating questions:', error);
                alert('Failed to generate questions. Please try again!');
                showScreen('home');
            }
        }

        function startQuestion() {
            showScreen('question');
            gameState.answerRevealed = false;
            gameState.currentAnswers.clear();
            
            const question = gameState.questions[gameState.currentQuestionIndex];
            
            document.getElementById('questionNumber').textContent = 
                `Question ${gameState.currentQuestionIndex + 1}/10`;
            document.getElementById('topicBadge').textContent = gameState.currentTopic;
            document.getElementById('questionText').textContent = question.question;
            
            const answersGrid = document.getElementById('answersGrid');
            answersGrid.innerHTML = question.answers.map((answer, index) => `
                <div class="answer-option" data-index="${index}">
                    <span class="answer-letter">${['A', 'B', 'C', 'D'][index]}</span>
                    ${answer.replace(/^[A-D]\)\s*/, '')}
                    <span class="answer-votes">0 votes</span>
                </div>
            `).join('');
            
            document.getElementById('revealBtn').disabled = false;
            document.getElementById('nextBtn').disabled = true;
        }

        // Answer Submission
        function processAnswer(username, answerLetter) {
            if (gameState.answerRevealed) return;
            
            const answerIndex = ['a', 'b', 'c', 'd'].indexOf(answerLetter.toLowerCase());
            if (answerIndex === -1) return;
            
            gameState.currentAnswers.set(username, answerIndex);
            updateAnswerVotes();
        }

        function updateAnswerVotes() {
            const voteCounts = [0, 0, 0, 0];
            gameState.currentAnswers.forEach(answer => voteCounts[answer]++);
            
            document.querySelectorAll('.answer-option').forEach((el, index) => {
                el.querySelector('.answer-votes').textContent = `${voteCounts[index]} votes`;
            });
        }

        function revealAnswer() {
            gameState.answerRevealed = true;
            const question = gameState.questions[gameState.currentQuestionIndex];
            const correctIndex = question.correct;
            
            document.querySelectorAll('.answer-option').forEach((el, index) => {
                if (index === correctIndex) {
                    el.classList.add('correct');
                } else {
                    el.classList.add('incorrect');
                }
            });
            
            // Award points
            gameState.currentAnswers.forEach((answer, username) => {
                if (answer === correctIndex) {
                    const currentScore = gameState.playerScores.get(username) || 0;
                    gameState.playerScores.set(username, currentScore + 1);
                    playSound('correct');
                } else {
                    playSound('wrong');
                }
            });
            
            setTimeout(() => playSound('success'), 300);
            
            document.getElementById('revealBtn').disabled = true;
            document.getElementById('nextBtn').disabled = false;
        }

        function nextQuestion() {
            gameState.currentQuestionIndex++;
            
            if (gameState.currentQuestionIndex >= gameState.questions.length) {
                showLeaderboard();
            } else {
                startQuestion();
            }
        }

        function showLeaderboard() {
            showScreen('leaderboard');
            
            const sortedPlayers = Array.from(gameState.playerScores.entries())
                .sort((a, b) => b[1] - a[1]);
            
            if (sortedPlayers.length > 0) {
                const [winner, score] = sortedPlayers[0];
                document.getElementById('winnerName').textContent = winner;
                document.getElementById('winnerScore').textContent = `${score}/10 Points!`;
                
                const topPlayersHTML = sortedPlayers.slice(0, 10).map(([name, score], index) => `
                    <div class="player-row">
                        <span class="player-rank">#${index + 1}</span>
                        <span class="player-name">${name}</span>
                        <span class="player-score">${score} pts</span>
                    </div>
                `).join('');
                
                document.getElementById('topPlayers').innerHTML = topPlayersHTML;
                
                playSound('success');
            }
        }

        function resetGame() {
            gameState.topics.clear();
            gameState.questions = [];
            gameState.currentQuestionIndex = 0;
            gameState.playerScores.clear();
            gameState.currentAnswers.clear();
            updateTopicList();
            showScreen('home');
        }

        // Chat command processing
        function processChatCommand(username, message) {
            const lowerMessage = message.toLowerCase().trim();
            
            if (lowerMessage.startsWith('!vote ')) {
                const voteNum = parseInt(lowerMessage.substring(6));
                processVote(username, voteNum);
            } else if (lowerMessage.match(/^![abcd]$/)) {
                processAnswer(username, lowerMessage.substring(1));
            }
        }

        // Test functions
        function testVote() {
            const topics = Array.from(gameState.topics.keys());
            if (topics.length > 0) {
                processVote('TestUser' + Math.floor(Math.random() * 100), Math.floor(Math.random() * topics.length) + 1);
            }
        }

        function testAnswer() {
            const username = document.getElementById('testUsername').value || 'TestUser';
            const answers = ['a', 'b', 'c', 'd'];
            processAnswer(username + Math.floor(Math.random() * 100), answers[Math.floor(Math.random() * 4)]);
        }

        function simulateChat() {
            if (gameState.currentScreen === 'home') {
                // Simulate votes
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => testVote(), i * 100);
                }
            } else if (gameState.currentScreen === 'question') {
                // Simulate answers
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => testAnswer(), i * 150);
                }
            }
        }

        // Expose for external integration
        window.processChatCommand = processChatCommand;
        
        // Generate topics when page loads
        generateTopics();
    </script>
</body>
</html>
